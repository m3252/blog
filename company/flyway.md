# 어떻게 하면 `flyway`를 잘 사용할 수 있을까?

회사에서 flyway를 사용하게 된 계기부터 사용하며 마주친 문제들, 그것을 해결해가는 과정에 대해 정리해보려 합니다.

- `flyway`란?
- `flyway`를 사용한 이유
- `flyway`를 사용하며 마주친 문제점
- `flyway`를 사용하며 생긴 문제 해결 과정


## `flyway`란?


## `flyway`를 사용한 이유


## `flyway`를 사용하며 마주친 문제점
우리 팀은 버전 관리를 위해 `Git`을 사용합니다. 워크플로는 메인 브랜치에서 새로운 브랜치를 생성하고, 생성한 브랜치에서 기능 구현 및 테스트를 끝낸 다음 해당 브랜치를 다시 메인 브랜치에 병합하는 방식입니다.
이런 워크플로에서 `flyway`를 사용하며 생겼던 문제에 대해 우선 말하려 합니다.


회사에서 새로운 개발 일정이 나왔고 그 기능들을 `챗봇`과 `추천 콘텐츠`라고 예시를 들겠습니다. 이 두 개의 기능은 각각 A, B 개발자에게 맡겨졌고 둘은 브랜치를 생성하여 일정을 시작하게 됐습니다.
개발을 끝낸 A가 프론트와 연동을 하여 테스트를 하기 위해 배포를 하는 과정에 문제가 생깁니다. 

바로 챗봇 기능을 추가하기 위해 생성한 DDL이 반영이 안되는 문제인데요.

왜 이런 문제가 발생하는지 자세히 살펴보기로 합니다.


## `flyway`를 사용하며 생긴 문제 해결 과정

### 1. 버전 충돌 방지, 접두사(Prefix)를 정수가 아닌 타임스탬프를 사용 

`flyway`를 통해 반영할 `sql`의 접두사로 많은 분들이 정수 값을 사용하고 있는것 같은데요. 저희도 도입 당시에 아무 생각없이 increment한 정수 값을 사용하고 있었습니다. 
그러다보니 잦은 버전 충돌이 일어났고 sql파일 이름을 수정하는 일이 빈번했는데요.

이런 문제를 해결하기 위해 접두사를 정수가 아닌 타임스탬프를 사용하기로 하였습니다.

- 202210211845__add_chat_table.sql
- 202210211843__add_recommend content_table.sql
- 202210211854__add_history_table_with_reference_to_chat_table.sql

단순히 정수를 타임스탬프로 바꾸는 것으로 서로 다른 개발자가 같은 이름의 sql을 생성할 일이 확 줄었습니다.

### 2. 버전 순차처리 옵션 OFF

`flyway`의 기본 버전 처리 순서는 순차적인 처리 방식입니다. 이 순차처리 방식을 사용할 경우 서로 다른 브랜치에서 생성된 sql이 데이터베이스에 반영이 될 것을 보장 못하는데요.

이런 상황을 해결하기 위해 flyway v2 에서 비순차처리 옵션 `out-of-order` 속성이 추가됐습니다.

```yaml
spring:
  flyway:
    out-of-order: false
```

### 3. 멱등성 있는 쿼리를 작성할 것 

멱등성 있는 쿼리는 우리에게 발생할 문제를 사전에 방지할 수 있습니다.

```mysql
-- 스키마 생성에 대한 체크
CREATE DATABASE IF NOT EXISTS `test`;
USE `test`;

-- 테이블 생성에 대한 체크
CREATE TABLE IF NOT EXISTS `tb_test` (
   `id` int(11) NOT NULL auto_increment,
   PRIMARY KEY  (`id`)
);
```

이렇게 멱등성을 가진 쿼리를 작성하고, 언급했던 규칙을 따르더라도 언제든 다른 문제가 발생할 수 있습니다.

다만, 우리 팀은 이런 규칙을 통해 `flyway`를 사용하며 발생했던 많은 문제를 해결할 수 있었고 또 다른 문제가 생기면 그것을 해결할 방법을 찾을 것 입니다.   